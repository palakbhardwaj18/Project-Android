name: Cloud Android 11 Phone (Win11 + Tailscale + RDP)

on:
  workflow_dispatch:

jobs:
  android-phone:
    runs-on: windows-latest
    timeout-minutes: 360  # 6 hours

    steps:
      - name: Checkout Repo
        uses: actions/checkout@v3

      # ---------------- Tailscale ----------------
      - name: Install Tailscale
        run: |
          curl -L https://pkgs.tailscale.com/stable/tailscale-setup-latest.exe -o tailscale-installer.exe
          Start-Process ".\tailscale-installer.exe" -ArgumentList "/quiet" -Wait
          & "C:\Program Files\Tailscale\tailscale.exe" version
          & "C:\Program Files\Tailscale\tailscale.exe" up --authkey ${{ secrets.TS_KEY }} --hostname github-cloudphone --accept-routes --accept-dns

      # ---------------- Java ----------------
      - name: Install Java
        run: choco install microsoft-openjdk11 -y

      # ---------------- Android Command Line Tools ----------------
      - name: Download Android Command Line Tools
        run: |
          curl -L https://dl.google.com/android/repository/commandlinetools-win-9477386_latest.zip -o cmd-tools.zip
          if (!(Test-Path "C:\Android")) { mkdir C:\Android }
          if (Test-Path "C:\Android\cmdline-tools\latest") { Remove-Item -Recurse -Force "C:\Android\cmdline-tools\latest" }
          mkdir C:\Android\cmdline-tools\latest
          Add-Type -AssemblyName System.IO.Compression.FileSystem
          [System.IO.Compression.ZipFile]::ExtractToDirectory("cmd-tools.zip","C:\Android\cmdline-tools\latest")
          # Fix nested folder
          Move-Item "C:\Android\cmdline-tools\latest\cmdline-tools\*" "C:\Android\cmdline-tools\latest\"
          Remove-Item "C:\Android\cmdline-tools\latest\cmdline-tools" -Recurse

      # ---------------- Set Environment Variables ----------------
      - name: Set ANDROID_HOME and PATH
        run: |
          echo "ANDROID_HOME=C:\Android" >> $env:GITHUB_ENV
          echo "ANDROID_SDK_ROOT=C:\Android" >> $env:GITHUB_ENV
          echo "C:\Android\cmdline-tools\latest\bin" >> $env:GITHUB_PATH
          echo "C:\Android\platform-tools" >> $env:GITHUB_PATH
          echo "C:\Android\emulator" >> $env:GITHUB_PATH

      # ---------------- Install Android 11 SDK & System Images ----------------
      - name: Install Android 11 SDK
        run: |
          & "C:\Android\cmdline-tools\latest\bin\sdkmanager.bat" --sdk_root="C:\Android" --install "platform-tools" "platforms;android-30" "system-images;android-30;google_apis;x86_64" "emulator" --verbose

      # ---------------- Create Android 11 AVD ----------------
      - name: Create Android 11 AVD
        run: |
          & "C:\Android\cmdline-tools\latest\bin\avdmanager.bat" --sdk_root="C:\Android" create avd -n cloudphone -k "system-images;android-30;google_apis;x86_64" --device "pixel" --force

      # ---------------- Launch Android Emulator (headless) ----------------
      - name: Launch Emulator
        run: |
          & "C:\Android\emulator\emulator.exe" -avd cloudphone -no-window -no-audio -no-snapshot &

      # ---------------- Enable RDP ----------------
      - name: Enable RDP
        run: |
          net user runneradmin MyStrongPassword123! /add
          net localgroup administrators runneradmin /add
          reg add "HKLM\SYSTEM\CurrentControlSet\Control\Terminal Server" /v fDenyTSConnections /t REG_DWORD /d 0 /f
          Enable-NetFirewallRule -DisplayGroup "Remote Desktop"

      # ---------------- Keep Alive ----------------
      - name: Keep Alive
        run: |
          echo "Cloud Android Phone is running..."
          ping -t 127.0.0.1 > NUL
